<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Masoveria del Bosc</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #3d5a40; --accent: #70a1ff; --bg: #fdfcf8; --text: #2d3436; --white: #ffffff; --danger: #d63031; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--white); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: var(--white); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; border-radius: 20px 20px 0 0; }
        .nav-item { text-align: center; color: #a4b0be; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 24px; display: block; }
        .section { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--white); border-radius: 18px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .vol-card { min-width: 150px; background: #eef2f3; padding: 12px; border-radius: 12px; margin-right: 10px; cursor: pointer; border: 2px solid transparent; }
        .vol-card.selected { border-color: var(--accent); background: #e3f2fd; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 5px; }
        #calendar { background: white; padding: 10px; border-radius: 15px; }
    </style>
</head>
<body>

<div id="loader"><img src="https://i.gifer.com/ZZ5H.gif" width="40"></div>

<div id="sec-tareas" class="section active">
    <h2>Tareas / Tasks</h2>
    <div id="cont-tareas-diarias"></div>
    <h4 style="margin-top:20px">General</h4>
    <div id="cont-tareas-general"></div>
</div>

<div id="sec-calendario" class="section">
    <h2>Calendario</h2>
    <div id="vol-list" style="display: flex; overflow-x: auto; margin-bottom: 15px;"></div>
    <div id="calendar"></div>
    <div class="card" style="margin-top:20px">
        <h4>Request Day Off / Solicitar Día</h4>
        <select id="sol-voluntario"></select>
        <input type="date" id="sol-fecha">
        <button onclick="enviarSolicitudLibre()">Solicitar / Request</button>
    </div>
</div>

<div id="sec-compras" class="section">
    <h2>Compras / Shopping</h2>
    <p style="font-size:0.8rem; color:orange">Check pantry first / Revisa despensa primero</p>
    <div id="cont-compras" style="margin-top:15px"></div>
    <div class="card">
        <select id="com-voluntario"></select>
        <input type="text" id="com-art" placeholder="Item / Artículo">
        <div style="display:flex; gap:5px">
            <input type="number" id="com-cant" placeholder="Qty">
            <select id="com-uni"><option>un</option><option>kg</option><option>paq</option><option>lts</option></select>
        </div>
        <button onclick="agregarALista()" style="background:#636e72">Add to list / Añadir</button>
        <button onclick="guardarTodo()" style="margin-top:10px">Save / Guardar</button>
        <button onclick="limpiarCompras()" style="background:var(--danger); margin-top:10px">Clear / Limpiar</button>
    </div>
</div>

<div id="sec-tickets" class="section">
    <h2>Tickets PQRS</h2>
    <div id="cont-tickets"></div>
    <div class="card">
        <select id="pqr-voluntario"></select>
        <select id="pqr-tipo">
            <option value="IP">Ideas/Proyectos</option>
            <option value="DI">Daño/Incidencia</option>
            <option value="S">Sugerencia</option>
        </select>
        <textarea id="pqr-msg" placeholder="Describe..."></textarea>
        <button onclick="enviarTicket()">Send / Enviar</button>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="nav('sec-tareas', this)"><i class="bi bi-check2-square"></i><span>Tareas</span></div>
    <div class="nav-item" onclick="nav('sec-calendario', this)"><i class="bi bi-calendar3"></i><span>Calendar</span></div>
    <div class="nav-item" onclick="nav('sec-compras', this)"><i class="bi bi-cart3"></i><span>Market</span></div>
    <div class="nav-item" onclick="nav('sec-tickets', this)"><i class="bi bi-chat-dots"></i><span>Tickets</span></div>
</nav>

<script>
    const API = "https://script.google.com/macros/s/AKfycbxBK0kLLRFuhectkf2qLbGh8jxggXB5c1C1IyYJYN_CCQ86u-_DnqX7f63ddUIkv0s/exec";
    let store = {};
    let calendar;

    async function init() {
        const r = await fetch(API, { method: 'POST', body: JSON.stringify({action: 'getAppData'}) });
        const d = await r.json();
        store = d.data;
        renderAll();
        document.getElementById('loader').style.display = 'none';
    }

    function nav(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        if(id === 'sec-calendario') { setTimeout(() => calendar.render(), 100); }
    }

    function renderAll() {
        const vols = store.Voluntarios.slice(1);
        const vHtml = vols.map(v => `<option value="${v[1]}">${v[1]}</option>`).join('');
        ['sol-voluntario', 'com-voluntario', 'pqr-voluntario'].forEach(id => document.getElementById(id).innerHTML = vHtml);

        // Calendario Voluntarios Tarjetas
        document.getElementById('vol-list').innerHTML = vols.map(v => `
            <div class="vol-card" onclick="highlightVol('${v[1]}','${v[3]}','${v[4]}', this)">
                <strong>${v[1]}</strong><br><small>${v[2]}<br>Until: ${v[4]}</small>
            </div>
        `).join('');

        // Tareas
        const tAll = store.DB_Tareas.slice(1);
        document.getElementById('cont-tareas-general').innerHTML = tAll.filter(t => t[5] !== 'Hecho').map(t => `
            <div class="card" onclick="cambiarEstadoTarea('${t[0]}')"><b>${t[1]}</b> - ${t[4]}</div>
        `).join('');

        // Compras y Tickets (similares)
        renderCompras();
        renderCalendar();
    }

    function renderCalendar() {
        const calEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calEl, {
            initialView: 'dayGridMonth', locale: 'es',
            events: store.DB_Calendario.slice(1).map(e => ({ title: e[1], start: e[2], end: e[3], color: e[4] === 'Verde' ? '#27ae60' : '#d63031' })),
            dateClick: function(info) { mostrarDetalleDia(info.dateStr); }
        });
        calendar.render();
    }

    function highlightVol(nombre, inicio, fin, el) {
        document.querySelectorAll('.vol-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        calendar.gotoDate(inicio);
        calendar.addEvent({ id: 'temp', title: 'ESTANCIA: ' + nombre, start: inicio, end: fin, display: 'background', color: '#70a1ff' });
        setTimeout(() => { calendar.getEventById('temp').remove(); }, 5000);
    }

    function mostrarDetalleDia(fecha) {
        const eventos = store.DB_Calendario.slice(1).filter(e => e[2] <= fecha && e[3] >= fecha);
        const presentes = store.Voluntarios.slice(1).filter(v => v[3] <= fecha && v[4] >= fecha);
        let html = `<b>Eventos:</b> ${eventos.length ? eventos.map(e => e[1]).join(', ') : 'Ninguno'}<br><br>`;
        html += `<b>Presentes:</b> ${presentes.map(v => v[1]).join(', ')}`;
        Swal.fire({ title: 'Día: ' + fecha, html: html });
    }

    async function enviarSolicitudLibre() {
        const fecha = document.getElementById('sol-fecha').value;
        const usuario = document.getElementById('sol-voluntario').value;
        if(!fecha) return;
        Swal.fire({title: 'Enviando...', didOpen: () => Swal.showLoading()});
        const r = await fetch(API, { method: 'POST', body: JSON.stringify({action: 'solicitarDia', fecha, usuario}) }).then(res => res.json());
        if(r.status === 'success') {
            Swal.fire('OK', 'Solicitado', 'success');
            document.getElementById('sol-fecha').value = '';
            init();
        } else {
            Swal.fire('Error', r.message, 'error');
        }
    }

    function renderCompras() {
        const cData = store.DB_Compras.slice(1);
        document.getElementById('cont-compras').innerHTML = cData.map(c => `<div class="card"><b>${c[1]}:</b> ${c[3]} ${c[4]} - ${c[2]}</div>`).join('');
    }

    async function agregarALista() {
        const usuario = document.getElementById('com-voluntario').value;
        const articulo = document.getElementById('com-art').value;
        const cantidad = document.getElementById('com-cant').value;
        const unidad = document.getElementById('com-uni').value;
        if(!articulo) return;
        await fetch(API, { method: 'POST', body: JSON.stringify({action: 'addCompra', usuario, articulo, cantidad, unidad}) });
        document.getElementById('com-art').value = '';
        init();
    }

    async function enviarTicket() {
        const usuario = document.getElementById('pqr-voluntario').value;
        const tipo = document.getElementById('pqr-tipo').value;
        const descripcion = document.getElementById('pqr-msg').value;
        if(!descripcion) return;
        await fetch(API, { method: 'POST', body: JSON.stringify({action: 'addTicket', usuario, tipo, descripcion}) });
        document.getElementById('pqr-msg').value = '';
        Swal.fire('Enviado', 'Ticket creado', 'success');
        init();
    }

    window.onload = init;
</script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
</body>
</html>
